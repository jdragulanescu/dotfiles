#!/usr/bin/env bash
#
# ghprofile - Display GitHub profile with contribution graph
# Requires: gh (GitHub CLI), jq
#
# Usage: ghprofile [months]
#   months: Number of months to display (1-12, default: 6)
#

set -euo pipefail

# Default months to display
DISPLAY_MONTHS=${1:-6}

# Validate input
if ! [[ "$DISPLAY_MONTHS" =~ ^[0-9]+$ ]] || [[ "$DISPLAY_MONTHS" -lt 1 ]] || [[ "$DISPLAY_MONTHS" -gt 12 ]]; then
    echo "Usage: ghprofile [months]"
    echo "  months: 1-12 (default: 6)"
    exit 1
fi

# Convert months to weeks (roughly 4.33 weeks per month)
DISPLAY_WEEKS=$(( (DISPLAY_MONTHS * 52 + 6) / 12 ))

# ============================================
# COLORS (Dracula-inspired)
# ============================================
RESET='\033[0m'
BOLD='\033[1m'
DIM='\033[2m'

# Greens for contribution levels (GitHub's actual colors)
GREEN_0='\033[38;5;238m'   # No contributions (#161b22)
GREEN_1='\033[38;5;22m'    # Low (#0e4429)
GREEN_2='\033[38;5;34m'    # Medium (#006d32)
GREEN_3='\033[38;5;40m'    # Medium-high (#26a641)
GREEN_4='\033[38;5;48m'    # High (#39d353)

# UI colors
CYAN='\033[38;5;117m'
PURPLE='\033[38;5;141m'
PINK='\033[38;5;212m'
YELLOW='\033[38;5;228m'
GRAY='\033[38;5;244m'
WHITE='\033[38;5;255m'

# ============================================
# DEPENDENCY CHECK
# ============================================
check_deps() {
    local missing=()
    command -v gh &>/dev/null || missing+=("gh")
    command -v jq &>/dev/null || missing+=("jq")

    if [[ ${#missing[@]} -gt 0 ]]; then
        echo -e "${PINK}Error:${RESET} Missing dependencies: ${missing[*]}"
        echo "Install with: brew install ${missing[*]}"
        exit 1
    fi

    # Check if gh is authenticated
    if ! gh auth status &>/dev/null; then
        echo -e "${PINK}Error:${RESET} GitHub CLI not authenticated"
        echo "Run: gh auth login"
        exit 1
    fi
}

# ============================================
# FETCH DATA
# ============================================
fetch_github_data() {
    local query='
    query {
        viewer {
            login
            name
            bio
            company
            location
            websiteUrl
            twitterUsername
            followers { totalCount }
            following { totalCount }
            repositories(privacy: PUBLIC, ownerAffiliations: OWNER) { totalCount }
            contributionsCollection {
                totalCommitContributions
                totalPullRequestContributions
                totalIssueContributions
                totalRepositoryContributions
                contributionCalendar {
                    totalContributions
                    weeks {
                        contributionDays {
                            contributionCount
                            weekday
                            date
                        }
                    }
                }
            }
        }
    }'

    gh api graphql -f query="$query" 2>/dev/null
}

# ============================================
# RENDER HELPERS
# ============================================
get_contribution_color() {
    local count=$1
    if [[ $count -eq 0 ]]; then
        echo -e "${GREEN_0}"
    elif [[ $count -le 3 ]]; then
        echo -e "${GREEN_1}"
    elif [[ $count -le 6 ]]; then
        echo -e "${GREEN_2}"
    elif [[ $count -le 9 ]]; then
        echo -e "${GREEN_3}"
    else
        echo -e "${GREEN_4}"
    fi
}

repeat_char() {
    local char="$1"
    local count="$2"
    printf "%${count}s" | tr ' ' "$char"
}

center_text() {
    local text="$1"
    local width="$2"
    local text_len=${#text}
    local padding=$(( (width - text_len) / 2 ))
    printf "%${padding}s%s" "" "$text"
}

# ============================================
# RENDER PROFILE
# ============================================
render_profile() {
    local data="$1"
    local viewer=$(echo "$data" | jq -r '.data.viewer')

    # Extract fields
    local login=$(echo "$viewer" | jq -r '.login // "unknown"')
    local name=$(echo "$viewer" | jq -r '.name // empty')
    local bio=$(echo "$viewer" | jq -r '.bio // empty')
    local company=$(echo "$viewer" | jq -r '.company // empty')
    local location=$(echo "$viewer" | jq -r '.location // empty')
    local website=$(echo "$viewer" | jq -r '.websiteUrl // empty')
    local twitter=$(echo "$viewer" | jq -r '.twitterUsername // empty')
    local followers=$(echo "$viewer" | jq -r '.followers.totalCount')
    local following=$(echo "$viewer" | jq -r '.following.totalCount')
    local repos=$(echo "$viewer" | jq -r '.repositories.totalCount')
    local total_contributions=$(echo "$viewer" | jq -r '.contributionsCollection.contributionCalendar.totalContributions')
    local commits=$(echo "$viewer" | jq -r '.contributionsCollection.totalCommitContributions')
    local prs=$(echo "$viewer" | jq -r '.contributionsCollection.totalPullRequestContributions')
    local issues=$(echo "$viewer" | jq -r '.contributionsCollection.totalIssueContributions')

    # Header
    echo ""

    # User info
    if [[ -n "$name" ]]; then
        echo -e "  ${WHITE}${BOLD}$name${RESET} ${GRAY}(@$login)${RESET}"
    else
        echo -e "  ${WHITE}${BOLD}@$login${RESET}"
    fi

    [[ -n "$bio" ]] && echo -e "  ${GRAY}$bio${RESET}"
    echo ""

    # Details
    [[ -n "$company" ]] && echo -e "  ${CYAN}󰳐${RESET}  $company"
    [[ -n "$location" ]] && echo -e "  ${CYAN}${RESET}  $location"
    [[ -n "$website" ]] && echo -e "  ${CYAN}󰖟${RESET}  $website"
    [[ -n "$twitter" ]] && echo -e "  ${CYAN}${RESET}  @$twitter"

    echo ""

    # Stats row
    echo -e "  ${PINK}${RESET} ${WHITE}$followers${RESET} followers  ${GRAY}·${RESET}  ${PINK}${RESET} ${WHITE}$following${RESET} following  ${GRAY}·${RESET}  ${PINK}󰳐${RESET} ${WHITE}$repos${RESET} repos"
    echo ""

    # Contribution stats
    echo -e "  ${YELLOW}${BOLD}$total_contributions${RESET} contributions ${GRAY}(past year)${RESET}"
    echo -e "  ${GREEN_4}${RESET} ${WHITE}$commits${RESET} commits  ${GREEN_3}${RESET} ${WHITE}$prs${RESET} PRs  ${GREEN_2}${RESET} ${WHITE}$issues${RESET} issues"
}

# ============================================
# RENDER CONTRIBUTION GRAPH
# ============================================
render_graph() {
    local data="$1"
    local weeks=$(echo "$data" | jq -r '.data.viewer.contributionsCollection.contributionCalendar.weeks')
    local num_weeks=$(echo "$weeks" | jq 'length')

    local start_week=$((num_weeks - DISPLAY_WEEKS))
    [[ $start_week -lt 0 ]] && start_week=0

    echo ""

    local days=("Sun" "Mon" "Tue" "Wed" "Thu" "Fri" "Sat")

    # Build the graph row by row (each row = day of week)
    for day_idx in 0 1 2 3 4 5 6; do
        printf "  ${GRAY}%s${RESET} " "${days[$day_idx]}"

        # Print each week's contribution for this day
        for ((week_idx = start_week; week_idx < num_weeks; week_idx++)); do
            local count=$(echo "$weeks" | jq -r ".[$week_idx].contributionDays[$day_idx].contributionCount // 0")
            local color=$(get_contribution_color "$count")
            printf "${color}■${RESET} "
        done
        echo ""
    done

    echo ""
    printf "      ${GRAY}Less${RESET} ${GREEN_0}■${RESET}${GREEN_1}■${RESET}${GREEN_2}■${RESET}${GREEN_3}■${RESET}${GREEN_4}■${RESET} ${GRAY}More${RESET}\n"
}

# ============================================
# MAIN
# ============================================
main() {
    check_deps

    echo -e "\n  ${DIM}Fetching GitHub data...${RESET}"
    local data
    data=$(fetch_github_data)

    # Clear the "fetching" line
    printf "\033[A\033[2K"

    render_profile "$data"
    render_graph "$data"
}

main "$@"
